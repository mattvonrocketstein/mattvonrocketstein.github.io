<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>DRY versioning for Python packages - heredoc</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://mattvonrocketstein.github.io/heredoc/img/favicon.ico" rel="icon">

<link rel="canonical" href="https://mattvonrocketstein.github.io/heredoc/dry-versioning-python.html">

        <meta name="author" content="mvr" />
        <meta name="keywords" content="python,fabric,boilerplate" />
        <meta name="description" content="DRY versioning for Python packages" />

        <meta property="og:site_name" content="heredoc" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="DRY versioning for Python packages"/>
        <meta property="og:url" content="https://mattvonrocketstein.github.io/heredoc/dry-versioning-python.html"/>
        <meta property="og:description" content="DRY versioning for Python packages"/>
        <meta property="article:published_time" content="2016-07-28" />
            <meta property="article:section" content="Python" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="fabric" />
            <meta property="article:tag" content="boilerplate" />
            <meta property="article:author" content="mvr" />


    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/heredoc.css" />
    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/jquery.tocify.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/style.css" type="text/css"/>




    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/bootstrap.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.tocify.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/respond.min.js"></script>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <a href="https://mattvonrocketstein.github.io/heredoc/" class="navbar-brand">
heredoc            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/pelican.html">Pelican</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">Fabric</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">Boilerplate</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">Python</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">Devops</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">Ansible</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">Elixir</a>
                        </li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2" id="sidebar">
            <div style="">
              <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://mattvonrocketstein.github.io/heredoc/img/avatar.png"/>
        </p>
    <p>
        <strong>About Me</strong><br/>
        
Raised by wild animals in ancient times, sandwiches are
the true guardians of my doomwagons.

    </p>
</div><h4>
  <i class="fa fa-home fa-lg"></i>
  <span class="icon-label">Recent</span></h4>
            <ul style="margin-left: 5px;padding:0px; list-style: none;">
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">
                            Python release automation</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html">
                            The missing "ansible-role" command</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/dry-versioning-python.html">
                            DRY versioning for Python packages</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/elixir-boilerplate.html">
                            Elixir boilerplate</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/pelican-boilerplate.html">
                            Pelican boilerplate</li>
                        </a>
              </ul>


              <a href="https://mattvonrocketstein.github.io/heredoc/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">
                            ansible
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">
                            boilerplate
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">
                            devops
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">
                            Elixir
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">
                            fabric
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/pelican.html">
                            pelican
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">
                            python
                        </a>
                    </li>
                </ul>

      <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
      <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="li-choice">
            <a href="http://data.holdings" target="_blank">
                data.holdings
            </a>
        </li>
      </ul>
            </aside>
            </div>
        </div>
        <div class="col-sm-8">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://mattvonrocketstein.github.io/heredoc/dry-versioning-python.html"
                       rel="bookmark"
                       title="Permalink to DRY versioning for Python packages">
                        DRY versioning for Python packages
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-07-28T00:00:00-04:00"> Thu 28 July 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">python</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">fabric</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">boilerplate</a>
    
</footer><!-- /.post-info -->
                    </div>
                </div>

                <p>A problem that comes up every time I make a new Pypi package is this: I want software version information to be included inside my python package and inside setup.py in a way that has a <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> and <a href="https://en.wikipedia.org/wiki/Single_source_of_truth">single source of truth</a>'y but also in such a way that I can increment the version automatically from release tools.  This post discusses a solution to this problem and <a href="#">is part of</a> a <a href="#">series discussing</a> other <a href="#">tricks</a> that can make release automation tasks easier.</p>
<h1>Choosing a project layout</h1>
<p>You might already have a directory layout for your python package, but if not it's time to choose one.  The best project layout for you will obviously depend on various things like whether you are releasing a library, a command-line application, whether your code also requires support-data, etc.  There are plenty of <a href="https://github.com/seanfisk/python-project-template">full-service project templates</a> out there, most of which are pretty opinionated.  If you use <a href="https://github.com/audreyr/cookiecutter">cookiecutter</a>, then have a look at the options <a href="https://github.com/audreyr/cookiecutter#python">here</a>.  Choose one you like, I'll wait...</p>
<h1>File Changes for DRY versions</h1>
<p>Hopefully you now have a project template that doesn't suck, but you might need some small changes to the skeleton to support DRY version data.  First, I'm assuming your new project layout looks something like what you'll find below.  If the <em>version.py</em> and <em>fabfile.py</em> files don't exist, create them.  I'll describe the contents later.</p>
<div class="highlight"><pre><span></span>pkg_root/
<span class="p">|</span>-- setup.py
<span class="p">|</span>-- fabfile.py
<span class="p">|</span>-- py_pkg
    <span class="p">|</span>-- __init__.py
    <span class="sb">`</span>-- version.py
</pre></div>


<h2>Version.py</h2>
<p>The <code>version.py</code> file contents should look something like what you see below.  Keep this file simple!  Don't use any imports because you want <code>setup.py</code> to still be able to import the version number, even when your package and it's dependencies are not yet installed.  </p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; py_pkg.version</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>


<h2>Setup.py</h2>
<p>Inside <code>setup.py</code>, import the version data and put it in the call to <code>setup()</code> as illustrated below:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; this is pkg_root/setup.py &quot;&quot;&quot;</span>

<span class="c1"># Inside pkg_root/setup.py, make sure we can import the version</span>
<span class="c1"># number so that it doesn&#39;t have to be changed in two places.  Note</span>
<span class="c1"># also that `pkg_root/py_pkg/__init__.py` is also free to import various</span>
<span class="c1"># requirements that haven&#39;t been installed yet</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s1">&#39;pkg_name&#39;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">version</span> <span class="kn">import</span> <span class="n">__version__</span>  <span class="c1"># flake8: noqa</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="n">setup</span><span class="p">(</span>
  <span class="c1"># ... stuff ..</span>
  <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
  <span class="c1"># ... more stuff ..</span>
<span class="p">)</span>
</pre></div>


<p>Once everything above is configured, you can change everything by hand if you want to.. at least now you only have to change it in once place.  However if you're interested in bumping the version from commandline without editing a file, or maybe bumping it from your buildbot after a test job passes, read on.  </p>
<h2>Fabfile.py</h2>
<p>I implement lots of simple automation using <a href="http://www.fabfile.org/">fabric</a>, and so it is for the <code>bump_version</code> command.  To install fabric itself you'll need to run the command below:</p>
<div class="highlight"><pre><span></span>pip install fabric
</pre></div>


<p>The fabfile with the <code>bump_version</code> command is <a href="https://gist.github.com/mattvonrocketstein/ac7c3fc1da4e696e58976324c414c72e">gisted here</a> and included below.  Basically you just need to run "fab bump_version" and it will rewrite the version.py file described previous.  </p>
<p>Be warned!  The version-bumper below assumes naive incremental decimal versioning and it won't JustWork™ with stuff like <a href="http://semver.org/">semver</a> out of the box.  The reason for that is because then the release automation gets somewhat less, well, automatic, in that case because the <code>bump_version</code> command would have parse tuples and accept arguments that described whether your changes were backwards compatible. Extending the solution is left as an exercise to the reader :)  </p>
<p><a href="https://gist.githubusercontent.com/mattvonrocketstein/ac7c3fc1da4e696e58976324c414c72e/raw/">View this gist on github</a></p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.console</span> <span class="kn">import</span> <span class="n">confirm</span>

<span class="n">_ope</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span>
<span class="n">_mkdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span>
<span class="n">_expanduser</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span>
<span class="n">_dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span>


<span class="n">PKG_NAME</span> <span class="o">=</span> <span class="s1">&#39;my_pkg&#39;</span>
<span class="n">VERSION_DELTA</span> <span class="o">=</span> <span class="o">.</span><span class="mo">01</span>


<span class="nd">@api.task</span>
<span class="k">def</span> <span class="nf">version_bump</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; bump the version number for &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">PKG_NAME</span>
    <span class="n">sandbox</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">version_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PKG_NAME</span><span class="p">,</span> <span class="s1">&#39;version.py&#39;</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;version file not found in expected location: &#39;</span> <span class="o">+</span> <span class="n">version_file</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">version_file</span><span class="p">),</span> <span class="n">err</span>
    <span class="c1"># running &quot;import pkg.version&quot; should have no side-effects,</span>
    <span class="c1"># so there&#39;s little point in parsing the file.  just exec</span>
    <span class="nb">execfile</span><span class="p">(</span><span class="n">version_file</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">)</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">sandbox</span><span class="p">[</span><span class="s1">&#39;__version__&#39;</span><span class="p">]</span>
    <span class="n">new_version</span> <span class="o">=</span> <span class="n">current_version</span> <span class="o">+</span> <span class="n">VERSION_DELTA</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">version_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
        <span class="n">version_file_contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">new_file</span> <span class="o">=</span> <span class="n">version_file_contents</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
        <span class="p">[</span><span class="s2">&quot;__version__={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_version</span><span class="p">)]</span>
    <span class="n">new_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">colors</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s2">&quot;warning:&quot;</span><span class="p">)</span> <span class="o">+</span> \
        <span class="s2">&quot; version will be changed to {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_version</span><span class="p">)</span>
    <span class="k">print</span>
    <span class="k">print</span> <span class="n">colors</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s2">&quot;new version file will look like this:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">new_file</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">confirm</span><span class="p">(</span><span class="s1">&#39;proceed with version change?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ans</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;aborting.&#39;</span>
        <span class="k">return</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">version_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhandle</span><span class="p">:</span>
        <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;version has been rewritten.&#39;</span>
<span class="n">bump_version</span> <span class="o">=</span> <span class="n">version_bump</span>
</pre></div>


<h1>Footnotes</h1>
                <script>
                  $(document).ready(
                    function(){
                      $("#toc").tocify(
                        {
                          context: '.entry-content',
                          selectors: "h2,h3,h4",
                          showAndHide: true,
                          showAndHideOnScroll: true,
                        }
                      )
                    }
                  );
                </script>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-2" >
          <section id=toc class="well well-sm">
            </section>
        </div>
      </div>

    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 mvr
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://mattvonrocketstein.github.io/heredoc/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'mattvonrocketstein',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

<script>
console.debug('st');
setTimeout(function(){
  console.debug('str');
  if (""==$('#toc').html().trim()){
    console.debug('strn');
    $("#toc").hide()
  }}, 2000)
  </script>
</body>
</html>