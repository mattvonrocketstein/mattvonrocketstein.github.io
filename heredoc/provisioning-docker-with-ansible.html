<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>heredoc - Provisioning Docker with Ansible</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://mattvonrocketstein.github.io/heredoc/img/favicon.ico" rel="icon">

<link rel="canonical" href="https://mattvonrocketstein.github.io/heredoc/provisioning-docker-with-ansible.html">

        <meta name="author" content="mvr" />
        <meta name="keywords" content="docker,ansible,devops" />
        <meta name="description" content="Provisioning Docker with Ansible (again)" />

        <meta property="og:site_name" content="heredoc" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Provisioning Docker with Ansible"/>
        <meta property="og:url" content="https://mattvonrocketstein.github.io/heredoc/provisioning-docker-with-ansible.html"/>
        <meta property="og:description" content="Provisioning Docker with Ansible (again)"/>
        <meta property="article:published_time" content="2016-07-20" />
            <meta property="article:section" content="devops" />
            <meta property="article:tag" content="docker" />
            <meta property="article:tag" content="ansible" />
            <meta property="article:tag" content="devops" />
            <meta property="article:author" content="mvr" />


    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/heredoc.css" />
    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/jquery.tocify.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/style.css" type="text/css"/>




    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/bootstrap.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.tocify.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/respond.min.js"></script>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <a href="https://mattvonrocketstein.github.io/heredoc/" class="navbar-brand">
heredoc            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/pelican.html">Pelican</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">Fabric</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">Boilerplate</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">Python</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">Devops</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">Ansible</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">Elixir</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/docker.html">Docker</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">Graphdb</a>
                        </li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2" id="sidebar">
            <div style="">
              <aside>
<div id="aboutme">

    
        <p>
            <center>
              <a id=stop_walking_man
                href="javascript:toggle_walking_man()">
              <img id=walking_man src="https://mattvonrocketstein.github.io/heredoc/img/walking_man.gif">
                <span style="position:relative;bottom:15px;">
                  <small><small>
                    <small><small>
                      click to stop animation
                    </small></small>
                  </small></small>
                </span>
              </a>
            </center>
        </p>
        <script>
          function toggle_walking_man(){
            var walking = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man_still.png';
            var still = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man.gif';
            var currently=$('#walking_man').attr('src');
            if (currently==walking){
              $('#walking_man').attr('src',still)
            }
            else {
              $('#walking_man').attr('src', walking)
            }
          }

        </script>

    <p>
        <strong>About Me</strong><br/>
        
Raised by wild animals in ancient times, sandwiches are
the true guardians of my doomwagons.

    </p>
</div><h4>
  <i class="fa fa-home fa-lg"></i>
  <span class="icon-label">Recent</span></h4>
            <ul style="margin-left: 5px;padding:0px; list-style: none;">
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-elixir.html">
                            Loading Wikipedia into Neo4j with Elixir</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">
                            Python release automation</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html">
                            The missing "ansible-role" command</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/python-dry-versioning.html">
                            DRY versioning for Python packages</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/elixir-boilerplate.html">
                            Elixir boilerplate</li>
                        </a>
              </ul>


              <a href="https://mattvonrocketstein.github.io/heredoc/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">
                            ansible
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">
                            boilerplate
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">
                            devops
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/docker.html">
                            docker
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">
                            elixir
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">
                            fabric
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">
                            graphdb
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/pelican.html">
                            pelican
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">
                            python
                        </a>
                    </li>
                </ul>

      <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
      <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="li-choice">
            <a href="http://data.holdings" target="_blank">
                data.holdings
            </a>
        </li>
      </ul>
            </aside>
            </div>
        </div>
        <div class="col-sm-8">
            <ol class="breadcrumb">
                <li><a href="https://mattvonrocketstein.github.io/heredoc" title="heredoc"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="https://mattvonrocketstein.github.io/heredoc/category/devops.html" title="devops">devops</a></li>
                <li class="active">Provisioning Docker with Ansible</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://mattvonrocketstein.github.io/heredoc/provisioning-docker-with-ansible.html"
                       rel="bookmark"
                       title="Permalink to Provisioning Docker with Ansible">
                        Provisioning Docker with Ansible
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-07-20T20:20:00-04:00"> Wed 20 July 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/docker.html">docker</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">ansible</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">devops</a>
    
</footer><!-- /.post-info -->
                    </div>
                </div>

                <h2>Docker and Ansible (Again)</h2>
<p>You want to provision docker with ansible, and you want to invoke ansible from the docker host (not from inside the container).  Nice, so <a href="https://www.ansible.com/docker">the number one result</a> searching for ansible/docker just gives you a "request more info" button!  Of course there are other search results but many are outdated, for old ansible, old docker, or both. Did you maybe find five different blog posts where it looks like each writer is just copy/pasting more or less verbatim what is written elsewhere?  </p>
<p>Generally speaking, despite what superficially looks like a lot of information and a lot of people already doing this, it was very frustrating to actually get this working.  Welcome to the dark side of hype.</p>
<p>My own instructions will probably be frustratingly out of date eventually or maybe produce mysterious errors for someone else today, but what the hell? They work for me.. at least today.  Let's throw more gas on the fire!</p>
<h2>Docker+SSH: the horror</h2>
<p>Yeah, yeah, yeah. <a href="https://jpetazzo.github.io/2014/06/23/docker-ssh-considered-evil/">Docker+ssh considered harmful</a> .  I disagree, at least for a great many use-cases, but can't be bothered to articulate all the arguments. Other people have already <a href="https://github.com/phusion/baseimage-docker#docker_single_process">been there</a> and <a href="https://github.com/jeroenpeeters/docker-ssh">done that</a> more expertly than I can manage anyway and at great length.  </p>
<p>All I have to add to that conversation is that I want my ansible stuff to JustWork™ whether it's pointed at vagrant, AWS, or docker and I'd prefer to avoid complicating the recipes or having tons of extra dependencies to accomplish this.  Is that so much to ask!?  You can always turn off ssh before deploying stuff.</p>
<p>The approach covered in this write-up uses <a href="https://github.com/phusion/baseimage-docker">phusion's baseimage-docker</a>.  Phusion's stuff is actually really well documented, but leaves out steps since it already assumes some experience with docker, and it doesn't cover the ansible angle.  The <a href="https://github.com/jeroenpeeters/docker-ssh">docker-ssh</a> approach initially looked very promising but it <a href="https://github.com/jeroenpeeters/docker-ssh/issues/9">doesn't work with scp</a>.</p>
<h2>Getting started</h2>
<h3>Dockerfile</h3>
<p>Create a new folder to work in, and edit <code>Dockerfile</code> to look something like what you see below.  </p>
<p>Useful links: the <a href="https://github.com/phusion/baseimage-docker/blob/master/Changelog.md">changelog</a> describes other baseimage versions, and <a href="https://github.com/phusion/baseimage-docker#enabling_the_insecure_key_permanently">this section</a> describes insecure-ssh-key related things.</p>
<div class="highlight"><pre><span></span><span class="c"># See https://github.com/phusion/baseimage-docker/blob/master/Changelog.md for</span>
<span class="c"># a list of version numbers.</span>
<span class="k">FROM</span><span class="s"> phusion/baseimage:0.9.19</span>

<span class="c"># Use baseimage-docker&#39;s init system.</span>
<span class="k">CMD</span><span class="s"> [&quot;/sbin/my_init&quot;]</span>

<span class="c"># Ansible will require python on the container</span>
<span class="k">RUN</span> apt-get update
<span class="k">RUN</span> apt-get install -y python2.7

<span class="c"># Enable ssh with insecure key permanently</span>
<span class="k">RUN</span> rm -f /etc/service/sshd/down
<span class="k">RUN</span> /usr/sbin/enable_insecure_key

<span class="c"># Clean up APT when done.</span>
<span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
</pre></div>


<h3>Boondoggles</h3>
<p>From now on, just for the sake of choosing names I bet you don't already have inside your systems, we're going to the word <strong>boondoggle</strong> everywhere that we can.  More specificially <strong>iboondoggle</strong> will be used to refer to an image, and <strong>cboondoggle</strong> to refer to containers derived from the image.</p>
<h3>Build image</h3>
<p>Inside the folder with your Dockerfile, construct the base image:</p>
<div class="highlight"><pre><span></span>$ docker build -t <span class="s2">&quot;iboondoggle&quot;</span> .
</pre></div>


<h3>Instantiate container</h3>
<p>Instantiate the <strong>iboondoggle</strong> image into the <strong>cboondoggle</strong> container in such a way that it's ready and waiting with the ssh server.</p>
<div class="highlight"><pre><span></span>$ docker run --name cboondoggle -t -i iboondoggle /sbin/my_init --enable-insecure-key
</pre></div>


<h2>Get Ready to Connect</h2>
<p>Download the insecure private key from phusion:</p>
<div class="highlight"><pre><span></span>$ curl -o insecure_key -fSL https://github.com/phusion/baseimage-docker/raw/master/image/services/sshd/keys/insecure_key
$ chmod <span class="m">600</span> insecure_key
</pre></div>


<h2>Make helpers</h2>
<h3>Disclaimer</h3>
<p>At this point, things get very bash'y which I kind of hate.  The trouble is there are a lot of long commands that are long, hard to remember, and hard to type.  These commands can also be based on variables that are potentially changing (like the container IP address).  If you leave something out, you're going to get mysterious errors.  You also might need to execute these commands repeatedly as you test things, so we're going to make some bash-functions to use as helpers.</p>
<h3>Finding the container IP</h3>
<p>Make a bash function "refresh_cip" to grab the IP address for the named container.  This address will be written to the <code>`$CIP</code> env-var for use by other functions and will be used to refresh the ansible inventory file.</p>
<div class="highlight"><pre><span></span><span class="c1"># &quot;CNAME&quot; stores the container name.  IMPORTANT:</span>
<span class="c1"># the refresh_cip&quot; function MUST have this variable available</span>
<span class="nv">CNAME</span><span class="o">=</span>cboondoggle

<span class="c1"># Bash function definition for &quot;refresh_cip&quot;</span>
$ refresh_cip<span class="o">(){</span>
  <span class="nb">export</span> <span class="nv">CIP</span><span class="o">=</span><span class="s2">&quot;`docker inspect -f \&quot;{{.NetworkSettings.IPAddress }}\&quot; </span><span class="nv">$CNAME</span><span class="s2">`&quot;</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">&quot;docker ansible_host=</span><span class="nv">$CIP</span><span class="s2"> ansible_python_interpreter=/usr/bin/python2.7&quot;</span> &gt; ansible.hosts<span class="p">;</span>
  <span class="o">}</span>

<span class="c1"># Test it / Example usage</span>
$ refresh_cip
$ <span class="nb">echo</span> <span class="nv">$CIP</span>
$ cat ansible.hosts
</pre></div>


<h3>Connecting to the container</h3>
<p>Make a bash function "run_ssh" to help with ssh'ing into your container.  Also works to execute individual commands.</p>
<div class="highlight"><pre><span></span><span class="c1"># creates the &quot;run_ssh&quot; function</span>
<span class="c1"># Bash function definition for &quot;run_ssh&quot;</span>
$ run_ssh<span class="o">(){</span>
  refresh_cip<span class="p">;</span> ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="se">\</span>
    -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null <span class="se">\</span>
    -i ./insecure_key <span class="se">\</span>
    root@<span class="nv">$CIP</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="o">}</span>

<span class="c1"># Test it / Example usage:</span>
<span class="c1"># display &quot;root&quot; or drop to shell</span>
$ run_ssh whoami
$ run_ssh
</pre></div>


<h3>Running ansible</h3>
<p>Create a trivial ansible playbook <code>ping.yml</code>, just to test with:</p>
<div class="highlight"><pre><span></span><span class="c1"># ping.yml</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>
  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test connection</span>
      <span class="l l-Scalar l-Scalar-Plain">ping</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
</pre></div>


<p>Make a bash function "run_ansible" to help with running ansible.  This function requires at least one argument (the playbook to use).  You can pass <a href="#">additional ansible arguments</a> if you like as well but ansible will complain if you pass any of the ones already mentioned below.</p>
<div class="highlight"><pre><span></span><span class="c1"># Bash function definition for &quot;run_ansible&quot;</span>
$ run_ansible<span class="o">(){</span>
  refresh_cip<span class="p">;</span>
  <span class="nb">export</span> <span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False
  ansible-playbook -vvv <span class="se">\</span>
    --user<span class="o">=</span>root --private-key<span class="o">=</span>./insecure_key <span class="se">\</span>
    --inventory<span class="o">=</span>ansible.hosts <span class="nv">$@</span><span class="p">;</span>
  <span class="o">}</span>

<span class="c1"># Test it / Example usage</span>
run_ansible ./ping.yml
</pre></div>


<h2>More complicated playbooks</h2>
<p>Phusion's baseimage is ubuntu-based, so using ansible's apt module is appropriate for installing system-level packages.</p>
<div class="highlight"><pre><span></span><span class="c1"># packages.yml</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Install system package</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pkg=tree state=installed</span>
</pre></div>
                <script>
                  $(document).ready(
                    function(){
                      $("#toc").tocify(
                        {
                          context: '.entry-content',
                          selectors: "h2,h3,h4",
                          showAndHide: true,
                          showAndHideOnScroll: true,
                        }
                      )
                    }
                  );
                </script>
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html">The missing "ansible-role" command</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">Python release automation</a></li>
    </ul>
</section>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-2" >
          <section id=toc class="well well-sm">
            </section>
        </div>
      </div>

    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 mvr
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://mattvonrocketstein.github.io/heredoc/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'mattvonrocketstein',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

<script>
setTimeout(function(){
  if (""==$('#toc').html().trim()){
    $("#toc").hide()
  }}, 1500)
  </script>
</body>
</html>