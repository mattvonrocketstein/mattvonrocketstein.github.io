<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>heredoc - Exploring data with Neo4j and Cypher</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://mattvonrocketstein.github.io/heredoc/img/favicon.ico" rel="icon">

<link rel="canonical" href="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html">

        <meta name="author" content="mvr" />
        <meta name="keywords" content="graphdb,data-science" />
        <meta name="description" content="Exploring Wikivoyage data with Neo4j with Elixir (continued)" />

        <meta property="og:site_name" content="heredoc" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Exploring data with Neo4j and Cypher"/>
        <meta property="og:url" content="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html"/>
        <meta property="og:description" content="Exploring Wikivoyage data with Neo4j with Elixir (continued)"/>
        <meta property="article:published_time" content="2016-08-31" />
            <meta property="article:section" content="Elixir" />
            <meta property="article:tag" content="graphdb" />
            <meta property="article:tag" content="data-science" />
            <meta property="article:author" content="mvr" />

    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/jquery.tocify.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/style.css" type="text/css"/>




    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/js.cookie.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/bootstrap.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.tocify.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/respond.min.js"></script>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icnavbaron-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mattvonrocketstein.github.io/heredoc/" class="navbar-brand">
heredoc            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li>
                      <a href="/heredoc/tag/python.html">Python</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/elixir.html">Elixir</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/devops.html">Devops</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/data-science.html">Data Science</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/misc.html">Misc</a>
                    </li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2" id="sidebar">
            <div style="">
              <aside>
<div id="aboutme">

    
        <p>
            <center>
              <a id=walkingman_toggle>
                <span id=walkingman_toggle_label style="font-size:7px;position:relative;bottom:15px;">
                      stop animation
                </span><br/>
              <img id=walking_man>
              </a>
            </center>
        </p>
        <script>
          var still = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man_still.png';
          var walking = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man.gif';
          function walkingman_on(){
            $('#walking_man').attr('src', walking);
            $('#walkingman_toggle_label').html('stop animation');
            $("#walkingman_toggle").attr(
                'href', 'javascript:walkingman_off()');
            Cookies.set('walkingman_animate', 1)
          }
          function walkingman_load(){
            var animate = Cookies.get("walkingman_animate")
            if(!animate||animate=="1"){
                walkingman_on()
            }
            else { walkingman_off();}
          }
          function walkingman_off(){
            $('#walking_man').attr('src', still);
            $('#walkingman_toggle_label').html('start animation');
            $("#walkingman_toggle").attr(
                'href', 'javascript:walkingman_on()');
            Cookies.set('walkingman_animate', 0)
          }
          $(document).ready(function(){
            walkingman_load();
            });
        </script>

    <p>
        <strong>Heredoc</strong><br/>
        is a file literal or input stream literal: it is a section of a source code file that is treated as if it were a separate file.  It also happens to be the name of this technical blog..
    </p>
</div><h4>
  <i class="fa fa-home fa-lg"></i>
  <span class="icon-label">Recent</span></h4>
            <ul style="margin-left: 5px;padding:0px; list-style: none;">
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/data-science-links.html">
                            Links for Topics in data-science</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html">
                            Exploring data with Neo4j and Cypher</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-elixir.html">
                            Loading MediaWiki into Neo4j with Elixir</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-vagrant-ansible.html">
                            Setting up neo4j with vagrant and ansible</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/ielixir-notebook-in-docker.html">
                            IElixir Notebook in Docker</li>
                        </a>
              </ul>


              <a href="https://mattvonrocketstein.github.io/heredoc/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">
                            ansible
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">
                            boilerplate
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/data-science.html">
                            data-science
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">
                            devops
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/docker.html">
                            docker
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">
                            elixir
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">
                            fabric
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">
                            graphdb
                        </a>
                    </li>
                    <li class="list-group-item tag-0">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/vagrant.html">
                            vagrant
                        </a>
                    </li>
                </ul>

      <h4><i class="fa fa-github fa-lg"></i>
        <span class="icon-label"><a href="https://github.com/mattvonrocketstein">
          GitHub Repos
        </a></span>
      </h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
      <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="li-choice">
            <a href="http://data.holdings" target="_blank">
                data.holdings
            </a>
        </li>
      </ul>
            </aside>
            </div>
        </div>
        <div class="col-sm-8">
            <ol class="breadcrumb">
                <li><a href="https://mattvonrocketstein.github.io/heredoc" title="heredoc"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="https://mattvonrocketstein.github.io/heredoc/category/elixir.html" title="Elixir">Elixir</a></li>
                <li class="active">Exploring data with Neo4j and Cypher</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html"
                       rel="bookmark"
                       title="Permalink to Exploring data with Neo4j and Cypher">
                        Exploring data with Neo4j and Cypher
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-08-31T00:00:00-04:00"> Wed 31 August 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">graphdb</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/data-science.html">data-science</a>
    
</footer><!-- /.post-info -->
                    </div>
                </div>

                <h2>Part 2: Intro</h2>
<p>This is part 2 of a two part series.  In <a href="neo4j-elixir.html">part 1</a> I wrote about using Elixir to parse <a href="http://wikivoyage.com">Wikivoyage</a> data dumps and push them into Neo4j.  If you want to follow along at home but you have no data locally, then you'll want to go back to that section before reading further.  If you've already seen part 1 or if you're only interested in the resulting datastructure and its interrogation, then you can read on from here.</p>
<p><img alt="results for continent query" src="img/neo-unesco.png"></p>
<h2>Exploring the Data</h2>
<p>To review from the first part of this series, what we have at this point is a simple but reasonably large graph, where nodes are WikiVoyage pages.  Most nodes<sup id="sf-neo4j-cypher-wikivoyage-1-back"><a href="#sf-neo4j-cypher-wikivoyage-1" class="simple-footnote" title="That is, all nodes with the exception of pages that are linked to from somewhere but do not actually exist">1</a></sup> have properties for <code>body</code> (i.e. unparsed page content), a <code>title</code> (i.e. the article title), and a <code>page_id</code>.  As far as edges, there are at this point only two kinds of relationships:</p>
<ol>
<li>the <strong>links_to</strong> relationship means our graph models how the webpage connects to itself</li>
<li>the <strong>contains</strong> relationship gives some extra semantic information about geopolitical regions</li>
</ol>
<p>In this part of the writeup, we'll interrogate and improve the data model.  What kind of questions can be asked and answered using it?  First a brief aside about graph visualization and queries..</p>
<p><strong>The web UI for Neo4j</strong> is at port 7474 by default or more specifically <a href="http://10.0.2.2:7474">http://10.0.2.2:7474</a> in the (unlikely) event you have exactly the same dual-guest vagrant setup as I do.  Point your webbrowser there and play around.  You can also see some vital statistics about the growth rate of nodes and relationships over time here at the /webadmin endpoint (for instance <a href="http://10.0.2.2:7474/webadmin/">http://10.0.2.2:7474/webadmin/</a>).</p>
<p><strong>There are several CLI clients available</strong>, but I recommend using <a href="https://github.com/nicolewhite/cycli">cycli</a> or <a href="ipython-cypher.readthedocs.io/en/latest/">ipython-cypher</a>.</p>
<p><strong>The Cypher Query Language</strong> is of course used to interrogate the graph, regardless of whether that is happening from Elixir code, from the WebUI, or from the CLI console.  There are <a href="https://neo4j.com/developer/cypher-query-language/">lots of introductions to cypher</a> out there but getting deep into that is outside of the scope of this write up and I'm still learning myself.  CQL is fairly readable though so the reader's intuition, plus <a href="https://neo4j.com/docs/cypher-refcard/current/">this quick reference</a>, plus brief commentary will hopefully suffice.</p>
<h2>Curating the Graph</h2>
<p>We've reached some kind of critical mass with the model, and it's possible now to use information in the graph to begin to improve the graph itself.  I'll be using cypher exclusively for this but keep in mind that most queries are  intended to be simple rather than performant.</p>
<h3>Finding Continents</h3>
<p><strong>Can we discover which nodes (that is, wikipages) correspond to continents?</strong>  Yes!  This is actually kind of a neat trick, because it's not like pages are <em>labeled</em> as continents, we don't have access to that much wikimedia ontology explicitly.  Instead, one has to recognize: continents are those nodes which "contain" other nodes but are not themselves contained.  A first guess at a naive query might look something like this</p>
<div class="highlight"><pre><span></span><span class="c1">// On the right track, but not quite correct</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">()</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
</pre></div>


<p>The simple query doesn't quite work because of a few warts in the datastructure.  We'll fix most of this stuff later in the <a href="#CuratingtheGraph">curation section</a> of this write-up, but for now just to list the short-comings:</p>
<ol>
<li>Pages without page_id's are linked to from somewhere but do not actual exist (or have not been parsed yet because <code>mix load</code> was interrupted).  These have to be excluded by making sure that the <code>page_id</code> property is set.</li>
<li>Redirect pages are somewhat like continents in that they are "root nodes" that "contain" no other entities on the graph.  These have to be excluded using a regex on the page body.  Similarly for disambiguation pages.</li>
</ol>
<p>With all this in mind you can puzzle out a more correct cypher query.</p>
<div class="highlight"><pre><span></span><span class="c1">// A better query that takes into account warts of the graph</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">()</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">continent</span><span class="p">.</span><span class="n">page_id</span><span class="w"> </span><span class="k">IS NULL</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">continent</span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="p">=</span><span class="err">~</span><span class="w"> </span><span class="err">'</span><span class="p">.*</span><span class="err">#</span><span class="n">REDIRECT</span><span class="p">.*</span><span class="err">'</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">continent</span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="n">STARTS</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="s">"{{pagebanner|Disambiguation"</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
</pre></div>


<p>In the screenshot below you can see that amongst the nodes returned as continents there are also nodes representing the pages for "Eurasia" and "Other Destinations".  This amount of error seems negligible though, so it's not worth adding special cases to exclude them</p>
<p><img alt="" src="img/neo-continents.png"></p>
<h3>Continent Labels</h3>
<p>Having found continents, we should label them to avoid such an awkward query in the future.  While we're at it, let's make use of the various subparts of this query to improve other graph semantics by adding new labels for <code>:Redirect</code> and <code>:Disambiguation</code>.</p>
<div class="highlight"><pre><span></span><span class="c1">// Query to label redirect pages as :Redirect</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="p">=</span><span class="err">~</span><span class="w"> </span><span class="err">'</span><span class="p">.*</span><span class="err">#</span><span class="n">REDIRECT</span><span class="p">.*</span><span class="err">'</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="p">:</span><span class="n">Redirect</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Query to label disambiguation pages as :disambiguation</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="n">STARTS</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="s">"{{pagebanner|Disambiguation"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="p">:</span><span class="n">Disambiguation</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>Now we can simplify the previous "find continents" query while we're adding the <code>:Continent</code> label</p>
<div class="highlight"><pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="w"> </span><span class="p">(:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">()</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">continent</span><span class="p">.</span><span class="n">page_id</span><span class="w"> </span><span class="k">IS NULL</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">continent</span><span class="p">:</span><span class="n">Redirect</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">continent</span><span class="p">:</span><span class="n">Disambiguation</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="p">:</span><span class="n">Continent</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
</pre></div>


<hr style="border-top: dotted 2px;">

<h3>Regional Hierarchies</h3>
<h4>Page-title data</h4>
<p><strong>What about other geopolitical or administrative hierarchies?  Can we discover countries, cities, etc?</strong>  There are a few obvious things we can do here, like taking advantage of patterns in page titles to find counties, provinces, and regions.</p>
<div class="highlight"><pre><span></span><span class="c1">// Query to label province pages as :Province</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="n">ENDS</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="s">"(province)"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="p">:</span><span class="n">Province</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Query to label county pages as :County</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="n">ENDS</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="s">"(county)"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="p">:</span><span class="n">County</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Query to label region pages as :Region</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="n">ENDS</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="s">"(region)"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="p">:</span><span class="n">Region</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h4>Page-body data</h4>
<p>At this point it's becoming clear the Wikivoyage <code>:contains</code> relationship hierarchy is somewhat complicated.  For instance since it is the case that Europe (a continent) contains Iberia (a region) which contains Spain (a country), there's no way that a naive query like "which nodes are exactly 1 <code>:contains</code> edge away from a continent" can be trusted to return <strong>only</strong> countries.</p>
<p>Now certain domain-specific WikiMedia knowledge can be useful, namely <a href="https://en.wikivoyage.org/wiki/Wikivoyage:Article_status">article status</a> <a href="https://en.wikivoyage.org/wiki/Category:Article_classification_templates">classification templates</a>, for instance <a href="https://en.wikivoyage.org/wiki/Template:Usablecity">{{UsableCity}}</a>.  Note however that up until now we've only been using cypher regexes on title-properties, but to find {{UsableCity}} macros we'd have to match on WikiPage <code>body</code> properties (essentially this is repeatedly grepping like half a gigabyte of text).  </p>
<p>I'll continue to use regexes and string functions in Cypher, but in production you should probably be using the full-text lucene search capabilities <sup id="sf-neo4j-cypher-wikivoyage-2-back"><a href="#sf-neo4j-cypher-wikivoyage-2" class="simple-footnote" title="which I've written about here">2</a></sup>.  </p>
<div class="highlight"><pre><span></span><span class="c1">// Label pages invoking the {{UsableCity}} macro as :City</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">body</span><span class="w"></span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{usablecity}}"</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">    </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{guidecity}}"</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">    </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{starcity}}"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">:</span><span class="n">City</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>For other labels we can do likewise and as a result our graph data structure will model the WikiVoyage ontology more and more closely.  Surprisingly, the <code>{{UsableCountry}}</code> template macro is not very useful so we skip that in the cypher code below.</p>
<div class="highlight"><pre><span></span><span class="c1">// Label pages invoking the {{UsableAirport}} macro as :Airport</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">body</span><span class="w"></span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"></span>
<span class="w">  </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{usableairport}}"</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{guideairport}}"</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{starairport}}"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">:</span><span class="n">Airport</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Label pages invoking the {{UsableRegion}} macro as :Region</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">WITH</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">body</span><span class="w"></span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"></span>
<span class="w">  </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{usableregion}}"</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{guideregion}}"</span><span class="w"> </span><span class="n">OR</span><span class="w"></span>
<span class="w">  </span><span class="n">body</span><span class="w"> </span><span class="n">CONTAINS</span><span class="w"> </span><span class="s">"{{starregion}}"</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">:</span><span class="n">Region</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h3>Finding Countries</h3>
<p>Having correct and fairly complete <code>:Country</code> labels for the graph would be really nice.  But based on <a href="https://en.wikivoyage.org/wiki/Special%3aWhatLinksHere/Template%3ausablecountry">this page</a> it's clear that identifying countries with the <code>{{UsableCountry}}</code> macro in page bodies is not painting a very complete picture.  To improve the model for our toy world (and to demonstrate some other neat things you can do with cypher) <strong>we'll have to cheat a bit</strong>.  The instructions below will download and parse <a href="https://github.com/opentraveldata/opentraveldata/blob/master/data/countries/27org/27org_iso_country_list_2007_12.sql">this country list</a>, provided via the <a href="https://github.com/opentraveldata/">OpenTravelData</a> project.  </p>
<p>This OpenTravelData stuff is in SQL, and I just quickly massaged it into shape with a bash pipeline.  The resulting text file is <a href="https://github.com/mattvonrocketstein/rapidmind/blob/master/country_list.txt">included in the rapidmind repository</a>.  Just for completeness, I'll be explicit about the bash pipeline below.</p>
<div class="highlight"><pre><span></span>$ wget -O country_list.sql https://raw.githubusercontent.com/opentraveldata/opentraveldata/master/data/countries/27org/27org_iso_country_list_2007_12.sql
$ cat country_list.sql <span class="p">|</span> grep INSERT <span class="p">|</span> awk -F <span class="s2">"\("</span> <span class="s1">'{print $2}'</span><span class="p">|</span>awk -F <span class="s2">",'"</span> <span class="s1">'{print substr($3,0,length($3))}'</span><span class="p">|</span>awk -F <span class="s2">"',"</span> <span class="s1">'{print $1}'</span>cat country_list.sql <span class="p">|</span> grep INSERT <span class="p">|</span> awk -F <span class="s2">"\("</span> <span class="s1">'{print $2}'</span><span class="p">|</span>awk -F <span class="s2">",'"</span> <span class="s1">'{print substr($3,0,length($3))}'</span><span class="p">|</span>awk -F <span class="s2">"',"</span> <span class="s1">'{print $1}'</span>
</pre></div>


<p>Luckily for us, a text file with newlines is a kind of CSV file and Neo4j does <a href="http://blog.comperiosearch.com/blog/2015/02/04/csv-import-tricks-neo4j/">CSV parsing</a>.  You do need to have the CSV file somehow available to the Neo4j server, so if you want to avoid copying a file to your virtual machine or whatever you can use the link I mentioned earlier from the rapidmind repository.</p>
<div class="highlight"><pre><span></span><span class="c1">// Query to label country nodes as :Country</span>
<span class="c1">WITH 'https://raw.githubusercontent.com/mattvonrocketstein/rapidmind/master/country_list.txt'</span>
<span class="k">AS</span><span class="w"> </span><span class="n">csv_url</span><span class="w"></span>
<span class="n">LOAD</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">csv_url</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">csv_line</span><span class="w"></span>
<span class="k">WITH</span><span class="w"> </span><span class="n">csv_line</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">country_name</span><span class="w"></span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">title</span><span class="p">=</span><span class="n">country_name</span><span class="w"></span>
<span class="k">SET</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="n">Country</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p></p><center>
  <img alt="results for country query" src="img/neo-country.png">
</center>
<hr style="border-top: dotted 2px;"><p></p>
<h2>Questions and Queries</h2>
<h3>Innate Ambiguity</h3>
<p><strong>How frequently does ambiguity occur in place names?</strong> This is a tricky question to answer <em>exactly</em> with the data but by counting redirects and disambiguation pages we can pretty easily find information that gets us pointed in the right direction.  The basic approach is</p>
<ol>
<li>Find all pages with mediawiki-style redirects with a regex.  The page body will look like <code>#REDIRECT [[RedirectTarget]]</code></li>
<li>Find the page each page redirects to, de-duplicate the resulting set and count the elements</li>
</ol>
<p>No doubt there's a better way to do it, but the cypher I came up with looks like what you see below.  The <code>split()</code> calls you see there are taking apart the <code>`[[link]]</code> markdown and the reference to "#" is handling a special-case where some pages redirect to <em>subsections</em> of other pages.</p>
<div class="highlight"><pre><span></span><span class="c1">// Counts unique redirection targets</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">Redirect</span><span class="p">)</span><span class="w"></span>
<span class="k">WITH</span><span class="w"></span>
<span class="w">  </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">split</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="err">'</span><span class="o">[[</span><span class="err">'</span><span class="p">)</span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="p">,</span><span class="err">'</span><span class="o">]]</span><span class="err">'</span><span class="p">)</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="p">,</span><span class="err">'#'</span><span class="p">)</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">redirect_to</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">redirect_to</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Counts disambiguation pages</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">Disambiguation</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">page</span><span class="p">)</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">page</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h3>Redirect Edges</h3>
<p>Since we've already written most of the correct query in the previous section, why not be opportunistic and add <code>:redirects_to</code> edges to the model?  It's tempting also to copy attributes and labels "across" the redirection edge, but I'm trying to avoid it until there's a specific use-case in mind (probably it would improve certain queries but be to the detriment of others).</p>
<div class="highlight"><pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">source</span><span class="p">:</span><span class="n">Redirect</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">WITH</span><span class="w"></span>
<span class="w">      </span><span class="n">source</span><span class="p">.</span><span class="n">title</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">split</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="err">'</span><span class="o">[[</span><span class="err">'</span><span class="p">)</span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="p">,</span><span class="err">'</span><span class="o">]]</span><span class="err">'</span><span class="p">)</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="p">,</span><span class="err">'#'</span><span class="p">)</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">target_title</span><span class="w"></span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="p">:</span><span class="n">WikiPage</span><span class="w"> </span><span class="p">{</span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">target_title</span><span class="p">})</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">redirects_to</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(*)</span><span class="w"></span>
</pre></div>


<hr style="border-top: dotted 2px;">

<h3>Popular Topics</h3>
<p><strong>What can we say about nodes (pages) with large numbers of out-going links?</strong> Apriori, there are a a few obvious guesses: these pages might represent meta-pages, very large land-masses, or very well-documented (and thus popular?) travel destinations.  You can see several such nodes in the output of the cypher query below:</p>
<div class="highlight"><pre><span></span><span class="c1">// Query for finding the top-ten nodes by link-count</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">-[</span><span class="n">r</span><span class="p">:</span><span class="n">links_to</span><span class="o">]-</span><span class="p">()</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rel_count</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">rel_count</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="m">10</span><span class="w"></span>
</pre></div>


<p>Taking for instance the meta-page for the <a href="https://en.wikivoyage.org/wiki/UNESCO_World_Heritage_List">UNESCO World Heritage List</a> here are some interesting queries:</p>
<div class="highlight"><pre><span></span><span class="c1">// Query to count the out-going links of a particular node</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-[</span><span class="n">rel</span><span class="o">]-&gt;</span><span class="p">()</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="p">=</span><span class="err">'</span><span class="n">UNESCO</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="n">Heritage</span><span class="w"> </span><span class="n">List</span><span class="err">'</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Query to graph part of the neighborhood in the WebUI</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="o">-[</span><span class="n">rel</span><span class="o">]-&gt;</span><span class="p">()</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="p">=</span><span class="err">'</span><span class="n">UNESCO</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="n">Heritage</span><span class="w"> </span><span class="n">List</span><span class="err">'</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">rel</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">10</span><span class="w"></span>
</pre></div>


<hr style="border-top: dotted 2px;">

<h3>Edge Weights</h3>
<p>Also in the previous section, we talked about a type of naive query that could not possibly work for finding countries 1 step beneath continents and cities 1 step beneath countries.  What we can do however is this: update "contains" edge in the graph to have a "containment-depth" property.  Edges where containment-depth==1 may not necessarily be countries, but this information ought to be at least heuristically useful in some other circumstance.</p>
<div class="highlight"><pre><span></span><span class="c1">// Placeholder</span>
</pre></div>


<h2>Other Ideas</h2>
<p>It's quite tempting to see what else can be done to make the data structure more complete, perhaps by using <a href="https://github.com/opentraveldata">open travel data</a> or by enhancing the dump parser to understand the <code>##Get In</code> and <code>##Get Out</code> sections of wikivoyage pages to make a "transport-connection" relationship type.  To be continued..</p>
<p>Placeholder</p>
<h2>Footnotes</h2>
<p><br></p><ol class="simple-footnotes"><li id="sf-neo4j-cypher-wikivoyage-1">That is, all nodes with the exception of pages that are linked to from somewhere but do not actually exist <a href="#sf-neo4j-cypher-wikivoyage-1-back" class="simple-footnote-back">↩</a></li><li id="sf-neo4j-cypher-wikivoyage-2">which I've written about <a href="neo4j-lucene.html">here</a> <a href="#sf-neo4j-cypher-wikivoyage-2-back" class="simple-footnote-back">↩</a></li></ol>
                <script>
                  $(document).ready(
                    function(){
                      $("#toc").tocify(
                        {
                          context: '.entry-content',
                          selectors: "h2,h3,h4",
                          showAndHide: true,
                          showAndHideOnScroll: true,
                        }
                      )
                    }
                  );
                </script>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-2" >
          <section id=toc class="well well-sm">
            </section>
        </div>
      </div>

    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 mvr
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://mattvonrocketstein.github.io/heredoc/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'mattvonrocketstein',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

<script>
setTimeout(function(){
  if (""==$('#toc').html().trim()){
    $("#toc").hide()
  }}, 1500)
  </script>
</body>
</html>