<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>heredoc - Exploring Wikivoyage data with Neo4j and Cypher</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://mattvonrocketstein.github.io/heredoc/img/favicon.ico" rel="icon">

<link rel="canonical" href="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html">

        <meta name="author" content="mvr" />
        <meta name="keywords" content="graphdb,data-science" />
        <meta name="description" content="Loading wikipedia into neo4j with Elixir (continued)" />

        <meta property="og:site_name" content="heredoc" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Exploring Wikivoyage data with Neo4j and Cypher"/>
        <meta property="og:url" content="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html"/>
        <meta property="og:description" content="Loading wikipedia into neo4j with Elixir (continued)"/>
        <meta property="article:published_time" content="2016-08-31" />
            <meta property="article:section" content="Elixir" />
            <meta property="article:tag" content="graphdb" />
            <meta property="article:tag" content="data-science" />
            <meta property="article:author" content="mvr" />

    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/jquery.tocify.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/style.css" type="text/css"/>




    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/js.cookie.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/bootstrap.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.tocify.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/respond.min.js"></script>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icnavbaron-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mattvonrocketstein.github.io/heredoc/" class="navbar-brand">
heredoc            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li>
                      <a href="/heredoc/tag/python.html">Python</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/elixir.html">Elixir</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/devops.html">Devops</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/data-science.html">Data Science</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/misc.html">Misc</a>
                    </li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2" id="sidebar">
            <div style="">
              <aside>
<div id="aboutme">

    
        <p>
            <center>
              <a id=walkingman_toggle>
                <span id=walkingman_toggle_label style="font-size:7px;position:relative;bottom:15px;">
                      stop animation
                </span><br/>
              <img id=walking_man>
              </a>
            </center>
        </p>
        <script>
          var still = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man_still.png';
          var walking = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man.gif';
          function walkingman_on(){
            $('#walking_man').attr('src', walking);
            $('#walkingman_toggle_label').html('stop animation');
            $("#walkingman_toggle").attr(
                'href', 'javascript:walkingman_off()');
            Cookies.set('walkingman_animate', 1)
          }
          function walkingman_load(){
            var animate = Cookies.get("walkingman_animate")
            if(!animate||animate=="1"){
                walkingman_on()
            }
            else { walkingman_off();}
          }
          function walkingman_off(){
            $('#walking_man').attr('src', still);
            $('#walkingman_toggle_label').html('start animation');
            $("#walkingman_toggle").attr(
                'href', 'javascript:walkingman_on()');
            Cookies.set('walkingman_animate', 0)
          }
          $(document).ready(function(){
            walkingman_load();
            });
        </script>

    <p>
        <strong>Heredoc</strong><br/>
        is a file literal or input stream literal: it is a section of a source code file that is treated as if it were a separate file.  It also happens to be the name of this technical blog..
    </p>
</div><h4>
  <i class="fa fa-home fa-lg"></i>
  <span class="icon-label">Recent</span></h4>
            <ul style="margin-left: 5px;padding:0px; list-style: none;">
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html">
                            Exploring Wikivoyage data with Neo4j and Cypher</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-elixir.html">
                            Loading Wikimedia data into Neo4j with Elixir</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-vagrant-ansible.html">
                            Setting up neo4j with vagrant and ansible</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/ielixir-notebook-in-docker.html">
                            IElixir Notebook in Docker</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">
                            Python release automation</li>
                        </a>
              </ul>


              <a href="https://mattvonrocketstein.github.io/heredoc/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">
                            ansible
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">
                            boilerplate
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/data-science.html">
                            data-science
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">
                            devops
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/docker.html">
                            docker
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">
                            elixir
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">
                            fabric
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">
                            graphdb
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/vagrant.html">
                            vagrant
                        </a>
                    </li>
                </ul>

      <h4><i class="fa fa-github fa-lg"></i>
        <span class="icon-label"><a href="https://github.com/mattvonrocketstein">
          GitHub Repos
        </a></span>
      </h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
      <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="li-choice">
            <a href="http://data.holdings" target="_blank">
                data.holdings
            </a>
        </li>
      </ul>
            </aside>
            </div>
        </div>
        <div class="col-sm-8">
            <ol class="breadcrumb">
                <li><a href="https://mattvonrocketstein.github.io/heredoc" title="heredoc"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="https://mattvonrocketstein.github.io/heredoc/category/elixir.html" title="Elixir">Elixir</a></li>
                <li class="active">Exploring Wikivoyage data with Neo4j and Cypher</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://mattvonrocketstein.github.io/heredoc/neo4j-cypher-wikivoyage.html"
                       rel="bookmark"
                       title="Permalink to Exploring Wikivoyage data with Neo4j and Cypher">
                        Exploring Wikivoyage data with Neo4j and Cypher
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-08-31T00:00:00-04:00"> Wed 31 August 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">graphdb</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/data-science.html">data-science</a>
    
</footer><!-- /.post-info -->
                    </div>
                </div>

                <h2>Intro</h2>
<p>This is part 2 of a two part series.  In <a href="neo4j-elixir.html">part 1</a> I wrote about using Elixir to parse wikivoyage data dumps and push them into neo4j.  If you want to follow along at home but you have no data locally, then you'll want to go back to that section before reading further.  If you've already seen part 1 or if you're only interested in the resulting datastructure and its interrogation, then you can read on from here.</p>
<p><img alt="" src="img/neo-unesco.png" /></p>
<h2>Exploring the data</h2>
<p>To review from the first part of this series, what we have at this point is a simple but reasonably large graph, where nodes are Wikivoyage pages.  There are two kinds of relationships:</p>
<ol>
<li>the <strong>links_to</strong> relationship means our graph models how the webpage connects to itself</li>
<li>the <strong>contains</strong> relationship gives some extra semantic information about geopolitical regions</li>
</ol>
<p>What kinds of questions can we ask and answer with this model?  First a brief aside about graph visualization and queries..</p>
<p><strong>The web UI for Neo4j</strong> is at port 7474 by default or more specifically <a href="http://10.0.2.2:7474">http://10.0.2.2:7474</a> in the (unlikely) event you have exactly the same dual-guest vagrant setup as I do.  Point your webbrowser there and play around.  You can also see some vital statistics about the growth rate of nodes and relationships over time here at the /webadmin endpoint (for instance <a href="http://10.0.2.2:7474/webadmin/">http://10.0.2.2:7474/webadmin/</a>).</p>
<p><strong>The Cypher Query Language</strong> is of course used to interrogate the graph.  There are <a href="https://neo4j.com/developer/cypher-query-language/">lots of introductions to cypher</a> out there but getting deep into that is outside of the scope of this write up and I'm still learning myself.  CQL is fairly readable though so the reader's intuition, plus <a href="https://neo4j.com/docs/cypher-refcard/current/">this quick reference</a>, plus brief commentary will hopefully suffice.</p>
<h2>Questions &amp; Queries</h2>
<p><strong>Can we discover which nodes (that is, wikipages) correspond to continents?</strong>  Yes!  This is actually kind of a neat trick, because it's not like pages are <em>labeled</em> as continents, we don't have access to that much wikimedia ontology explicitly.  Instead, one has to recognize: continents are those nodes which "contain" other nodes but are not themselves contained.  Then you can puzzle out the correct cypher query:</p>
<div class="highlight"><pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(()</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">))</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
</pre></div>


<hr style="border-top: dotted 2px;" />

<p><strong>What about other geopolitical hierarchies?  Countries, cities, etc?</strong>  Since the previous query was able to discover continents, it's possible that we could just update the graph, tagging the continent nodes as such with a <a href="http://graphaware.com/neo4j/2015/01/16/neo4j-graph-model-design-labels-versus-indexed-properties.html">label or a property</a>.  If we did that then a query like this could discover things that are one level beneath continents via the "contains" relation:</p>
<div class="highlight"><pre><span></span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">Continent</span><span class="p">)</span><span class="w"> </span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">country</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
</pre></div>


<p>But, suppose we try it without updating the original graph.  Lacking a <code>Continent</code> label, we just need to return a different part of the same query that helped us discover continents.  Specifically:</p>
<div class="highlight"><pre><span></span><span class="c1">// Returns countries?</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">country</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(()</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">))</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">30</span><span class="w"></span>

<span class="c1">// Returns cities?</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">country</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"> </span><span class="err">-</span><span class="p">&gt;</span><span class="w"> </span><span class="o">[</span><span class="p">:</span><span class="n">contains</span><span class="o">]</span><span class="err">-</span><span class="p">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="n">city</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(()</span><span class="o">-[</span><span class="p">:</span><span class="n">contains</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">continent</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">))</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">30</span><span class="w"></span>
</pre></div>


<p>But sadly these queries are too naive.  They only return nodes that are one or two steps below continents in terms of the "contains" relationship, respectively. That's because Wikivoyage has more complex regional hierarchies  where instead of finding that "Europe directly contains Spain", you will find that "Europe contains Iberia which contains Spain".  Hmmm.</p>
<hr style="border-top: dotted 2px;" />

<p><strong>What can we say about nodes (pages) with large numbers of out-going links?</strong> Apriori, there are a a few obvious guesses: meta-pages, very large land-masses, or very well-documented (and thus popular) travel destinations.  You can see several such nodes in the output of the <code>mix stat</code> command mentioned above, and in the screenshot below.</p>
<p>Taking for instance the meta-page for the <a href="https://en.wikivoyage.org/wiki/UNESCO_World_Heritage_List">UNESCO World Heritage List</a> here are some interesting queries:</p>
<div class="highlight"><pre><span></span><span class="c1">// Query to count the out-going links of a particular node</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-[</span><span class="n">rel</span><span class="o">]-&gt;</span><span class="p">()</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="p">=</span><span class="err">&#39;</span><span class="n">UNESCO</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="n">Heritage</span><span class="w"> </span><span class="n">List</span><span class="err">&#39;</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span><span class="w"></span>

<span class="c1">// Query to graph part of the neighborhood in the WebUI</span>
<span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="p">:</span><span class="n">WikiPage</span><span class="p">)</span><span class="o">-[</span><span class="n">rel</span><span class="o">]-&gt;</span><span class="p">()</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">title</span><span class="p">=</span><span class="err">&#39;</span><span class="n">UNESCO</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="n">Heritage</span><span class="w"> </span><span class="n">List</span><span class="err">&#39;</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">rel</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="m">10</span><span class="w"></span>
</pre></div>


<h2>Curating the Graph</h2>
<p>Based on some of the ideas in the previous section, let's augment the graph itself with some of what we learned from both successful and unsuccessful queries.  In other words this section contains cypher that actually update the graph instead of just querying it.  </p>
<p>First, a cypher query that  <a href="http://graphaware.com/neo4j/2015/01/16/neo4j-graph-model-design-labels-versus-indexed-properties.html">tags</a> the pages corresponding to continents as Continents.</p>
<div class="highlight"><pre><span></span><span class="c1">// Placeholder</span>
</pre></div>


<p>Also in the previous section, we talked about a type of naive query that could not possibly work for finding countries 1 step beneath continents and cities 1 step beneath countries.  What we can do however is this: update "contains" edge in the graph to have a "containment-depth" property.  Edges where containment-depth==1 may not necessarily be countries, but this information ought to be at least heuristically useful in some other circumstance.</p>
<div class="highlight"><pre><span></span><span class="c1">// Placeholder</span>
</pre></div>


<h2>Extending the Graph</h2>
<p>Placeholder</p>
<h2>Footnotes</h2>
                <script>
                  $(document).ready(
                    function(){
                      $("#toc").tocify(
                        {
                          context: '.entry-content',
                          selectors: "h2,h3,h4",
                          showAndHide: true,
                          showAndHideOnScroll: true,
                        }
                      )
                    }
                  );
                </script>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-2" >
          <section id=toc class="well well-sm">
            </section>
        </div>
      </div>

    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 mvr
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://mattvonrocketstein.github.io/heredoc/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'mattvonrocketstein',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

<script>
setTimeout(function(){
  if (""==$('#toc').html().trim()){
    $("#toc").hide()
  }}, 1500)
  </script>
</body>
</html>