<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>heredoc - The missing "ansible-role" command</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://mattvonrocketstein.github.io/heredoc/img/favicon.ico" rel="icon">

<link rel="canonical" href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html">

        <meta name="author" content="mvr" />
        <meta name="keywords" content="ansible,python,devops" />
        <meta name="description" content="Ansible-role downloads, installs, and cleans temporary ansible roles without the need for manually editing ansible playbooks" />

        <meta property="og:site_name" content="heredoc" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="The missing &#34;ansible-role&#34; command"/>
        <meta property="og:url" content="https://mattvonrocketstein.github.io/heredoc/ansible-role.html"/>
        <meta property="og:description" content="Ansible-role downloads, installs, and cleans temporary ansible roles without the need for manually editing ansible playbooks"/>
        <meta property="article:published_time" content="2016-07-28" />
            <meta property="article:section" content="misc" />
            <meta property="article:tag" content="ansible" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="devops" />
            <meta property="article:author" content="mvr" />

    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/jquery.tocify.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/style.css" type="text/css"/>




    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/js.cookie.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/bootstrap.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.tocify.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/respond.min.js"></script>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icnavbaron-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://mattvonrocketstein.github.io/heredoc/" class="navbar-brand">
heredoc            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li>
                      <a href="/heredoc/tag/python.html">Python</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/elixir.html">Elixir</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/devops.html">Devops</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/data-science.html">Data Science</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/essays.html">Essays</a>
                    </li>
                    <li>
                      <a href="/heredoc/tag/links.html">Links</a>
                    </li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2" id="sidebar">
            <div style="">
              <aside>
<div id="aboutme">

    
        <p>
            <center>
              <a id=walkingman_toggle>
                <span id=walkingman_toggle_label style="font-size:7px;position:relative;bottom:15px;">
                      stop animation
                </span><br/>
              <img id=walking_man>
              </a>
            </center>
        </p>
        <script>
          var still = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man_still.png';
          var walking = 'https://mattvonrocketstein.github.io/heredoc/img/walking_man.gif';
          function walkingman_on(){
            $('#walking_man').attr('src', walking);
            $('#walkingman_toggle_label').html('stop animation');
            $("#walkingman_toggle").attr(
                'href', 'javascript:walkingman_off()');
            Cookies.set('walkingman_animate', 1)
          }
          function walkingman_load(){
            var animate = Cookies.get("walkingman_animate")
            if(!animate||animate=="1"){
                walkingman_on()
            }
            else { walkingman_off();}
          }
          function walkingman_off(){
            $('#walking_man').attr('src', still);
            $('#walkingman_toggle_label').html('start animation');
            $("#walkingman_toggle").attr(
                'href', 'javascript:walkingman_on()');
            Cookies.set('walkingman_animate', 0)
          }
          $(document).ready(function(){
            walkingman_load();
            });
        </script>

    <p>
        <strong>Heredoc</strong><br/>
        is a file literal or input stream literal: it is a section of a source code file that is treated as if it were a separate file.  It also happens to be the name of this technical blog..
    </p>
</div><h4>
  <i class="fa fa-home fa-lg"></i>
  <span class="icon-label">Recent</span></h4>
            <ul style="margin-left: 5px;padding:0px; list-style: none;">
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/pi-elixir.html">
                            Dockerizing Elixir for Raspberry Pi / ARM</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/polyglot-advocacy.html">
                            Advocacy for Polyglot Programming</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/bitcoin-ethereum-executive-summary.html">
                            Bitcoin & Ethereum: Executive Summary</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/exploring-wikivoyage-data-with-neo4j-and-cypher-part-1-loading-data.html">
                            Exploring WikiVoyage data with Neo4j and Cypher: Part 1 (Loading Data)</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/exploring-wikivoyage-data-with-neo4j-and-cypher-part-2.html">
                            Exploring WikiVoyage data with Neo4j and Cypher: Part 2</li>
                        </a>
              </ul>


              <a href="https://mattvonrocketstein.github.io/heredoc/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">
                            ansible
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">
                            boilerplate
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/code.html">
                            code
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/cs.html">
                            cs
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/data-science.html">
                            data-science
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">
                            devops
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/docker.html">
                            docker
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">
                            elixir
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/essays.html">
                            essays
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">
                            fabric
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">
                            graphdb
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/infrastructure.html">
                            infrastructure
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/links.html">
                            links
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/math.html">
                            math
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/misc.html">
                            misc
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">
                            python
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/raspberry-pi.html">
                            raspberry-pi
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/unfinished.html">
                            unfinished
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/vagrant.html">
                            vagrant
                        </a>
                    </li>
                </ul>

      <h4><i class="fa fa-github fa-lg"></i>
        <span class="icon-label"><a href="https://github.com/mattvonrocketstein">
          GitHub Repos
        </a></span>
      </h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
      <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="li-choice">
            <a href="http://data.holdings" target="_blank">
                data.holdings
            </a>
        </li>
        <li class="li-choice">
            <a href="http://mattvonrocketstein.github.io/travel" target="_blank">
                travel blog
            </a>
        </li>
        <li class="li-choice">
            <a href="http://localhost:8000/heredoc/random.html" target="_blank">
                random article (this blog)
            </a>
        </li>
      </ul>
            </aside>
            </div>
        </div>
        <div class="col-sm-8">
            <ol class="breadcrumb">
                <li><a href="https://mattvonrocketstein.github.io/heredoc" title="heredoc"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="https://mattvonrocketstein.github.io/heredoc/category/misc.html" title="misc">
                  misc
                </a></li>
                <li class="active">The missing "ansible-role" command</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <span class=long-h1>
                    <a href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html"
                       rel="bookmark"
                       title="Permalink to The missing "ansible-role" command">
                        The missing "ansible-role" command
                    </a>
                </span>
            </header>
            <div class="entry-content">
<footer class="post-info">
    <table style="border-collapse: separate;border-spacing:5px 1px;">
<tr>
  <td class=center>
      <span class="label label-default">Date</span>
  </td>
  <td>
    <span class="published">
      <i class="fa fa-calendar"></i>
      <time datetime="2016-07-28T00:00:00-04:00">
        Thu 28 July 2016
      </time>
    </span>
  </td>
</tr><tr>
	<td class=center>
		<span class="label label-default">
			Tags
		</span>
	</td>
	<td>
			<a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">ansible</a>
,			<a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">python</a>
,			<a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">devops</a>
	</td>
</tr>
  </table>
</footer>
<!-- /.post-info -->                <br/>
                <h2>The Problem</h2>
<p>Whenever I'm building a server or simple local infrastructure for testing code, I start by looking at the <a href="https://galaxy.ansible.com/explore#/">available ansible roles</a>, hoping to find one that JustWorks for my use-case right out of the box.  One thing that annoys me though is that even for roles without extra variables, a playbook is still required.  Sure it's a small file, but creating it still annoys me when I'm just testing stuff.</p>
<p>Typically these one-off playbooks look something like this:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nv">role</span><span class="p p-Indicator">:</span> <span class="nv">username.rolename</span><span class="p p-Indicator">}</span>
</pre></div>


<p>There's a regular need for "anonymous roles", ie role application without using playbooks, even if only for simple use-cases.  </p>
<h2>Prior Art</h2>
<p>There's <a href="https://github.com/bbrfkr/ansible-art">already</a> <a href="https://github.com/msabramo/ansible_role_apply">a few</a> <a href="http://blog.oddbit.com/2015/10/19/stupid-ansible-tricks-running-a-role-from-the-command-line/">projects</a> that work around this, but none of them fit my use-case exactly (see the spec below).  </p>
<p>All implementations seem to agree with my conclusion on one point though: while it's very attractive to consider using the ansible API directly (if only to have a practical task in mind while you get to know the API), doing this is awkward.  The simplest approach is to just create a temporary <code>playbook.yml</code> file, then run an appropriate <code>ansible-playbook</code> command on that file and get rid of it afterwards.</p>
<h2>The Specification</h2>
<p>I specifically wanted the following behaviour from the missing <code>ansible-role</code> command:</p>
<ul>
<li>
<p>The <code>ansible-role</code> invocation should respect data intended for the <code>ansible-playbook</code> command, i.e. <code>ANSIBLE_*</code> shell variables should be passed through, and the unparsed aspect of the <code>ansible-role</code> command line also should be passed through to <code>ansible-playbook</code>.</p>
</li>
<li>
<p>Despite pass-through, the <code>ansible-role</code> command should also parse and understand the <em>--module-path=FOO</em> argument if it is given, and by default look for roles inside <code>FOO/roles</code>.</p>
</li>
<li>
<p>In the event no matching role is available locally then the role should be downloaded for me automatically using the <code>ansible-galaxy</code> command.</p>
</li>
<li>
<p>In case a galaxy download is necessary and <code>--modulepath=FOO</code> is specified, it is downloaded to <code>FOO/roles</code> and not cleaned afterwards.  <em>File-system caching makes sense here because the <code>ansible-role</code> invocation is supposed to be quick and easy, but the usage of the role itself is less experimental.</em></p>
</li>
<li>
<p>In case a galaxy download is necessary and <code>--modulepath</code> is <strong>NOT</strong> given, then there is no caching.  <em>File system cleaning for the role download makes sense here because this is a one-off experiment and it's no use cluttering the file system.</em>  Thus the role will be downloaded to a temporary directory and will be deleted afterwards (regardless of whether the application of the role succeeds).</p>
</li>
<li>
<p>Apart from the standard <code>ansible-playbook</code> arguments, the <code>ansible-role</code> command line understands exactly 2 other arguments: the primary positional argument <code>role_name</code> (which is required and which specifies an ansible-galaxy role), and the <code>host</code> argument (which defaults to <code>localhost</code>).  Again, <strong>everything else</strong> on the command line will be passed through to the <code>ansible-playbook</code> invocation.</p>
</li>
<li>
<p>After cleanup, the <code>ansible-role</code> command should return the same exit code as the implied <code>ansible-playbook</code> invocation.</p>
</li>
<li>
<p>Finally, the <code>ansible-role</code> command should be available on pypi so it can be installed with pip.</p>
</li>
</ul>
<h2>Examples</h2>
<p>Most of the requirements above are straightforward, but let's look at a few examples.  The invocation <code>ansible-role username.rolename --module-path ./ansible --become</code> will download the role if it doesn't exist, and result in the command <code>ansible-playbook --module-path ./ansible --become $random_tmp_playbook.yml</code>, and the role will not be cleaned.  The temporary playbook will be cleaned after it is used, and the contents of it are:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nv">role</span><span class="p p-Indicator">:</span> <span class="nv">./ansible/roles/username.rolename</span><span class="p p-Indicator">}</span>
</pre></div>


<p>The invocation <code>ansible-role username.rolename test_server</code> will definitely download the role, and result in the command <code>ansible-playbook  $random_tmp_playbook.yml</code>, and the role will be deleted after it is used.  The temporary playbook will also be cleaned after it is used, and the contents of the playbook are:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_server</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nv">role</span><span class="p p-Indicator">:</span> <span class="nv">$some_tmpdir/roles/username.rolename</span><span class="p p-Indicator">}</span>
</pre></div>


<h2>Overrides</h2>
<p>If you need to override variables using this approach to "anonymous" roles, then honestly it might be time to consider writing and maintaining an actual playbook file.  But if you insist, then you can always take advantage of <a href="http://docs.ansible.com/ansible/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">ansible variable preference precedence</a> and pass <code>--extra-vars "var=val"</code> to your <code>ansible-role</code> command.</p>
<h2>The Code</h2>
<p>All this is of course available on <a href="https://github.com/mattvonrocketstein/ansible-role">github</a> and <a href="https://pypi.python.org/pypi/ansible-role">pypi</a>.</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts-well">
    <ul>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/datadog-event-publishing.html">Datadog event publishing</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">Python release automation</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/ielixir-notebook-in-docker.html">IElixir Notebook in Docker</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-vagrant-ansible.html">Setting up Neo4j with Vagrant and Ansible</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/provisioning-docker-with-ansible.html">How to provision Docker with Ansible</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/pi-elixir.html">Dockerizing Elixir for Raspberry Pi / ARM</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/python-dry-versioning.html">DRY versioning for Python packages</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/devops-links.html">Links for Topics in Devops</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/python-multimethods.html">Python method semantics</a></li>
    </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-2" >
          <section id=toc class="well well-sm">
          </section>
        </div>
      </div>

    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 mvr
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://mattvonrocketstein.github.io/heredoc/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'mattvonrocketstein',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

<script>
$(document).ready(
  function(){
    $('.simple-footnotes').wrap("<section class=well id=footnotes-well></section>");
    $('#footnotes-well').before("<h2>Footnotes</h2>");
    $('#series-well').before("<h2>Articles in Series</h2>");
    $('#related-posts-well').before("<h2>Related Posts</h2>");
    $("#toc").delay(1000).tocify(
      {
        context: '.entry-content',
        selectors: "h2,h3,h4",
        showAndHide: true,
        showAndHideOnScroll: true,
        extendPage: false,
      }
    );
  }
);
function series_button(url,txt){
  return '<a style="background:#efefef;" class="btn btn-default btn-xs" href="'+url+'">'+txt+'</a>'

}
function get_series_nav(x){}</script>
<script>
setTimeout(function(){
  if (""==$('#toc').html().trim()){
    $("#toc").hide()
  }}, 1500)
  </script>
</body>
</html>