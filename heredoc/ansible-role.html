<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>heredoc - The missing "ansible-role" command</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://mattvonrocketstein.github.io/heredoc/img/favicon.ico" rel="icon">

<link rel="canonical" href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html">

        <meta name="author" content="mvr" />
        <meta name="keywords" content="ansible,python" />
        <meta name="description" content="The missing &#34;ansible-role&#34; command" />

        <meta property="og:site_name" content="heredoc" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="The missing &#34;ansible-role&#34; command"/>
        <meta property="og:url" content="https://mattvonrocketstein.github.io/heredoc/ansible-role.html"/>
        <meta property="og:description" content="The missing &#34;ansible-role&#34; command"/>
        <meta property="article:published_time" content="2016-07-28" />
            <meta property="article:section" content="misc" />
            <meta property="article:tag" content="ansible" />
            <meta property="article:tag" content="python" />
            <meta property="article:author" content="mvr" />


    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/heredoc.css" />
    <link type="text/css" rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/jquery.tocify.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://mattvonrocketstein.github.io/heredoc/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mattvonrocketstein.github.io/heredoc/theme/css/style.css" type="text/css"/>




    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/bootstrap.min.js"></script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/jquery.tocify.min.js"></script>

    <!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/respond.min.js"></script>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container-fluid">
        <div class="navbar-header">
            <a href="https://mattvonrocketstein.github.io/heredoc/" class="navbar-brand">
heredoc            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/pelican.html">Pelican</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">Fabric</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">Boilerplate</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">Python</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">Devops</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">Ansible</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">Elixir</a>
                        </li>
                        <li >
                            <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">Graphdb</a>
                        </li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2" id="sidebar">
            <div style="">
              <aside>
<div id="aboutme">

    
        <p>
            <center>
              <a id=stop_walking_man
                href="javascript:toggle_walking_man()">
              <img id=walking_man src="http://localhost:8000/heredoc/img/walking_man.gif">
                <span style="position:relative;bottom:15px;">
                  <small><small>
                    <small><small>
                      click to stop animation
                    </small></small>
                  </small></small>
                </span>
              </a>
            </center>
        </p>
        <script>
          function toggle_walking_man(){
            var walking = 'http://localhost:8000/heredoc/img/walking_man_still.png';
            var still = 'http://localhost:8000/heredoc/img/walking_man.gif';
            var currently=$('#walking_man').attr('src');
            if (currently==walking){
              $('#walking_man').attr('src',still)
            }
            else {
              $('#walking_man').attr('src', walking)
            }
          }

        </script>

    <p>
        <strong>About Me</strong><br/>
        
Raised by wild animals in ancient times, sandwiches are
the true guardians of my doomwagons.

    </p>
</div><h4>
  <i class="fa fa-home fa-lg"></i>
  <span class="icon-label">Recent</span></h4>
            <ul style="margin-left: 5px;padding:0px; list-style: none;">
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/neo4j-elixir.html">
                            Loading Wikipedia into Neo4j with Elixir</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">
                            Python release automation</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html">
                            The missing "ansible-role" command</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/python-dry-versioning.html">
                            DRY versioning for Python packages</li>
                        </a>
                        <li class=li-choice><a href="https://mattvonrocketstein.github.io/heredoc/elixir-boilerplate.html">
                            Elixir boilerplate</li>
                        </a>
              </ul>


              <a href="https://mattvonrocketstein.github.io/heredoc/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">
                            ansible
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/boilerplate.html">
                            boilerplate
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/devops.html">
                            devops
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/elixir.html">
                            elixir
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/fabric.html">
                            fabric
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/graphdb.html">
                            graphdb
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/pelican.html">
                            pelican
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">
                            python
                        </a>
                    </li>
                </ul>

      <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
      <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="li-choice">
            <a href="http://data.holdings" target="_blank">
                data.holdings
            </a>
        </li>
      </ul>
            </aside>
            </div>
        </div>
        <div class="col-sm-8">
            <ol class="breadcrumb">
                <li><a href="https://mattvonrocketstein.github.io/heredoc" title="heredoc"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="https://mattvonrocketstein.github.io/heredoc/category/misc.html" title="misc">misc</a></li>
                <li class="active">The missing "ansible-role" command</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://mattvonrocketstein.github.io/heredoc/ansible-role.html"
                       rel="bookmark"
                       title="Permalink to The missing "ansible-role" command">
                        The missing "ansible-role" command
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-07-28T00:00:00-04:00"> Thu 28 July 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/ansible.html">ansible</a>
        /
	<a href="https://mattvonrocketstein.github.io/heredoc/tag/python.html">python</a>
    
</footer><!-- /.post-info -->
                    </div>
                </div>

                <h2>The Problem</h2>
<p>Whenever I'm building a server or simple local infrastructure for testing code, I start by looking at the <a href="#">available ansible roles</a>, hoping to find one that works for my use-case out the box.  One thing that annoys me though is that even for roles without extra variables, a playbook is still required.  It's a small file, but creating it annoys me when I'm just testing stuff.</p>
<p>Typically these one-off playbooks look something like this:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">become_method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sudo</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nv">role</span><span class="p p-Indicator">:</span> <span class="nv">username.rolename</span><span class="p p-Indicator">}</span>
</pre></div>


<p>There's a regular need for "anonymous roles", ie role application without using playbooks, even if only for simple use-cases.  </p>
<h2>Prior Art</h2>
<p>There's <a href="https://github.com/bbrfkr/ansible-art">already</a> <a href="https://github.com/msabramo/ansible_role_apply">a few</a> <a href="http://blog.oddbit.com/2015/10/19/stupid-ansible-tricks-running-a-role-from-the-command-line/">projects</a> that work around this, but none of them fit my use-case exactly (see the spec below).  </p>
<p>All implementations seem to agree with my conclusion on one point though: while it's very attractive to consider using the ansible API directly (if only to have a practical task in mind while you get to know the API), doing this is awkward.  The simplest approach is to just create a temporary <code>playbook.yml</code> file, then run an appropriate <code>ansible-playbook</code> command on that file and get rid of it afterwards.</p>
<h2>The Specification</h2>
<p>I specifically wanted the following behaviour from the missing <code>ansible-role</code> command:</p>
<ul>
<li>
<p>The <code>ansible-role</code> invocation should respect data intended for the <code>ansible-playbook</code> command, i.e. <code>ANSIBLE_*</code> shell variables should be passed through, and the unparsed aspect of the <code>ansible-role</code> command line also should be passed through to <code>ansible-playbook</code>.</p>
</li>
<li>
<p>Despite pass-through, the <code>ansible-role</code> command should also parse and understand the <em>--module-path=FOO</em> argument if it is given, and by default look for roles inside <code>FOO/roles</code>.</p>
</li>
<li>
<p>In the event no matching role is available locally then the role should be downloaded for me automatically using the <code>ansible-galaxy</code> command.</p>
</li>
<li>
<p>In case a galaxy download is necessary and <code>--modulepath=FOO</code> is specified, it is downloaded to <code>FOO/roles</code> and not cleaned afterwards.  <em>File-system caching makes sense here because the <code>ansible-role</code> invocation is supposed to be quick and easy, but the usage of the role itself is less experimental.</em></p>
</li>
<li>
<p>In case a galaxy download is necessary and <code>--modulepath</code> is <strong>NOT</strong> given, then there is no caching.  <em>File system cleaning for the role download makes sense here because this is a one-off experiment and it's no use cluttering the file system.</em>  Thus the role will be downloaded to a temporary directory and will be deleted afterwards (regardless of whether the application of the role succeeds).</p>
</li>
<li>
<p>Apart from the standard <code>ansible-playbook</code> arguments, the <code>ansible-role</code> command line understands exactly 2 other arguments: the primary positional argument <code>role_name</code>, which is required and which specifies an ansible-galaxy role, and the <code>host</code> argument (which defaults to <code>localhost</code>).  Again, <strong>everything else</strong> on the command line will be passed through to the <code>ansible-playbook</code> invocation.</p>
</li>
<li>
<p>After cleanup, the <code>ansible-role</code> command should return the same exit code as the implied <code>ansible-playbook</code> invocation.</p>
</li>
<li>
<p>Finally, the <code>ansible-role</code> command should be available on pypi so it can be installed with pip.</p>
</li>
</ul>
<h2>Examples</h2>
<p>Most of the requirements above are straightforward, but let's look at a few examples.  The invocation <code>ansible-role username.rolename --module-path ./ansible --become</code> will download the role if it doesn't exist, and result in the command <code>ansible-playbook --module-path ./ansible --become $random_tmp_playbook.yml</code>, and the role will not be cleaned.  The temporary playbook will be cleaned after it is used, and the contents of it are:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nv">role</span><span class="p p-Indicator">:</span> <span class="nv">./ansible/roles/username.rolename</span><span class="p p-Indicator">}</span>
</pre></div>


<p>The invocation <code>ansible-role username.rolename test_server</code> will definitely download the role, and result in the command <code>ansible-playbook  $random_tmp_playbook.yml</code>, and the role will be deleted after it is used.  The temporary playbook will also be cleaned after it is used, and the contents of the playbook are:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_server</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nv">role</span><span class="p p-Indicator">:</span> <span class="nv">$some_tmpdir/roles/username.rolename</span><span class="p p-Indicator">}</span>
</pre></div>


<h2>Overrides</h2>
<p>If you need to override variables using this approach to "anonymous" roles, then honestly it might be time to consider writing and maintaining an actual playbook file.  But if you insist, then you can always take advantage of <a href="http://docs.ansible.com/ansible/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">ansible variable preference precedence</a> and pass <code>--extra-vars "var=val"</code> to your <code>ansible-role</code> command.</p>
<h2>The Code</h2>
<p>All this is of course available on <a href="https://github.com/mattvonrocketstein/ansible-role">github</a> and <a href="https://pypi.python.org/pypi/ansible-role">pypi</a>.</p>
                <script>
                  $(document).ready(
                    function(){
                      $("#toc").tocify(
                        {
                          context: '.entry-content',
                          selectors: "h2,h3,h4",
                          showAndHide: true,
                          showAndHideOnScroll: true,
                        }
                      )
                    }
                  );
                </script>
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/pelican-boilerplate.html">Pelican boilerplate</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/python-dry-versioning.html">DRY versioning for Python packages</a></li>
        <li><a href="https://mattvonrocketstein.github.io/heredoc/python-release-automation.html">Python release automation</a></li>
    </ul>
</section>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-2" >
          <section id=toc class="well well-sm">
            </section>
        </div>
      </div>

    </div>
</div>
<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 mvr
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://mattvonrocketstein.github.io/heredoc/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'mattvonrocketstein',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://mattvonrocketstein.github.io/heredoc/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

<script>
setTimeout(function(){
  if (""==$('#toc').html().trim()){
    $("#toc").hide()
  }}, 1500)
  </script>
</body>
</html>