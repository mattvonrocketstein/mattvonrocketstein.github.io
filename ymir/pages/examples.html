<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ymir</title>
    <meta name="description" content="">
    <meta name="author" content="mvr">

    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
        <script src="https://mattvonrocketstein.github.io/ymir/theme/html5.js"></script>
        <![endif]-->

    <script src="https://mattvonrocketstein.github.io/ymir/theme/js/jquery.min.js"></script>

    <!-- Styles -->
    <link href="https://mattvonrocketstein.github.io/ymir/theme/bootstrap.min.css" rel="stylesheet">
    <link href="https://mattvonrocketstein.github.io/ymir/theme/local.css" rel="stylesheet">
    <link href="https://mattvonrocketstein.github.io/ymir/theme/pygments.css" rel="stylesheet">

    <!-- Feeds -->




  </head>
  <body>
    <div class="topbar">
      <div class="topbar-inner">
        <div class="container-fluid">
          <a class="brand" href="https://mattvonrocketstein.github.io/ymir/">ymir</a>
          <ul class="nav">
            <li><a href="https://mattvonrocketstein.github.io/ymir/">About</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/installation.html">Installation</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/ec2.html">Quickstart: EC2</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/vagrant.html">Quick Start: Vagrant</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/service-description.html">Service Descriptions</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/service-operations.html">Service Operations</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/service-implementations.html">Service Implementations</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/examples.html">Examples</a></li>
            <li><a href="https://mattvonrocketstein.github.io/ymir/pages/misc.html">Misc.</a></li>
          </ul>
          <p class="pull-right">
            <a href="https://github.com/mattvonrocketstein/ymir/">[github]</a>
            <!--a href="https://github.com/mattvonrocketstein/ymir/issues">[issues]</a>
          </p-->
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="sidebar">
        <div class="well">
          <h3>Contents</h3>
          <ul class=main_toc>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/">About</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#what-is-it">What is it?</a></li>
<li><a href="#who-is-it-for">Who is it for?</a></li>
<li><a href="#under-the-hood">Under the hood</a></li>
<li><a href="#features">Features</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/installation.html">Installation</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#suggested-software">Suggested software</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/ec2.html">Quickstart: EC2</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#create-boilerplate">Create Boilerplate</a></li>
<li><a href="#customize-things">Customize things</a></li>
<li><a href="#validate-and-create">Validate and create</a></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/vagrant.html">Quick Start: Vagrant</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#create-boilerplate">Create boilerplate</a></li>
<li><a href="#customize-things">Customize things</a><ul>
<li><a href="#5-customize-your-service-implementation">5 Customize your service implementation</a></li>
</ul>
</li>
<li><a href="#validate-and-create">Validate and create</a></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/service-description.html">Service Descriptions</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#choosing-a-file">Choosing a file</a></li>
<li><a href="#templating"><a href="#templating" name="templating">Templating</a></a></li>
<li><a href="#ec2-json">EC2 JSON</a></li>
<li><a href="#vagrant-json">Vagrant JSON</a></li>
<li><a href="#health-checks">Health Checks</a></li>
<li><a href="#setup-provision">Setup &amp; provision</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/service-operations.html">Service Operations</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#built-in-operations">Built-in Operations</a></li>
<li><a href="#setup-operation">Setup Operation</a></li>
<li><a href="#provision-operation">Provision Operation</a></li>
<li><a href="#check-operation">Check Operation</a></li>
<li><a href="#custom-operations">Custom Operations</a></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/service-implementations.html">Service Implementations</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#prerequisite-reading">Prerequisite reading</a></li>
<li><a href="#puppet-provisioning">Puppet Provisioning</a><ul>
<li><a href="#puppet-deps">Puppet Deps</a></li>
<li><a href="#puppet-facts">Puppet Facts</a></li>
</ul>
</li>
<li><a href="#ansible-provisioning">Ansible Provisioning</a><ul>
<li><a href="#ansible-deps">Ansible Deps</a></li>
<li><a href="#ansible-facts">Ansible Facts</a></li>
</ul>
</li>
<li><a href="#other-provisioning">Other Provisioning</a><ul>
<li><a href="#local-commands">Local commands</a></li>
<li><a href="#remote-commands">Remote commands</a></li>
</ul>
</li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/examples.html">Examples</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#polyglot-demo">Polyglot demo</a></li>
<li><a href="#custom-operations">Custom Operations</a></li>
<li><a href="#python">Python</a></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul>
</div>
              </nav>
            </li>
            <li class=page_toc>
              <a href="https://mattvonrocketstein.github.io/ymir/pages/misc.html">Misc.</a>
              <nav class="sub_toc">
                <div class="toc">
<ul>
<li><a href="#automation-helpers">Automation Helpers</a></li>
<li><a href="#validating-boilerplate">Validating boilerplate</a></li>
<li><a href="#creating-keypairs">Creating Keypairs</a></li>
<li><a href="#synchronizing-security-groups">Synchronizing security groups</a></li>
</ul>
</div>
              </nav>
            </li>
          </ul>
        </div>
        <script>
          $('ul.main_toc nav.sub_toc li > a').each(function(){
            $(this).attr(
               'href',
               $(this).closest('.page_toc').children()[0].href+$(this).attr('href'));
          });
        </script>
        <div class="well">
          <h3>Other Links</h3>
          <ul>
            <li><a href="https://github.com/mattvonrocketstein/ymir/">Source code</a></li>
            <li><a href="https://github.com/mattvonrocketstein/ymir/issues">Issues</a></li>
          </ul>
        </div>
      </div>
      <div class="content">
        <div class='page'>
                <div class="page-header"><h1>Examples</h1></div>
                <div>
<p>Ymir <a href="#">source code</a> includes various demos that showcase functionality and can be used for integration testing ymir itself.</p>
<h4 id="polyglot-demo">Polyglot demo</h4>
<p>Ymir ships with a demo that is setup to work with AWS and vagrant, and shows how to configure a system with a combination of ansible and puppet using shared variables.  See <a href="https://github.com/mattvonrocketstein/ymir/blob/master/demos/polyglot/README.md">the README</a> below for more information</p>
<script src="https://gist-it.appspot.com/github/mattvonrocketstein/ymir/blob/vagrant/demos/polyglot/README.md"></script>
<h4 id="custom-operations">Custom Operations</h4>
<p><strong>About the default fabfile</strong></p>
<p>If you only want to do provisioning with ymir then you need not worry about exactly how ymir uses <a href="http://docs.fabfile.org/en/latest/tutorial.html">fabric</a>, but if you want to implement custom command and control <a href="service-operations.html">service operations</a> then it is worth understanding.</p>
<p>Ymir fabfiles typically contain the same preamble which is responsible for loading the service object from the service definition, and publishing various methods on the service object as fabric commands.  All that is accomplished in the default <code>fabfile.by</code> which is created in <code>ymir init</code>.  You can view the standard code below:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">ymir</span> <span class="kn">import</span> <span class="n">load_service_from_json</span>

<span class="c1"># use service.json file from YMIR_SERVICE_JSON env var or look in cwd</span>
<span class="n">YMIR_SERVICE_JSON</span> <span class="o">=</span> <span class="n">guess_service_json_file</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">'service.json'</span><span class="p">)</span>

<span class="c1"># Create the ymir service from the service description</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">load_service_from_json</span><span class="p">(</span><span class="n">YMIR_SERVICE_JSON</span><span class="p">)</span>

<span class="c1"># Install the standard service operations here</span>
<span class="c1"># (like create, terminate, provision, etc) as fabric commands.</span>
<span class="c1"># Custom service operations can be defined below this point.</span>
<span class="n">service</span><span class="o">.</span><span class="n">fabric_install</span><span class="p">()</span>
</pre></div>
<h4 id="python">Python</h4>
<p><strong>Fabric tasks as service operations:</strong></p>
<p>Defining a custom service operation is mostly the same as <a href="http://docs.fabfile.org/en/1.11/usage/tasks.html#the-task-decorator">writing a normal fabric task</a>.  Here's an example deploy task, which uses a mixture of standard fabric remote execution, standard fabric local execution, and bits of the ymir api as helpers.  After the <code>deploy</code> operation below is defined in your fabfile it is available to you now just like other service operations, so you can invoke it with <code>fab deploy:branch_name</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">api</span>

<span class="c1">## .. standard ymir preamble here, see previous examples ..</span>

<span class="n">SRC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s1">'code'</span><span class="p">)</span>
<span class="n">DEPLOY_PATH</span> <span class="o">=</span> <span class="s2">"/srv/site/"</span>

<span class="nd">@api.task</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">branch</span><span class="o">=</span><span class="s1">'master'</span><span class="p">):</span>
    <span class="sd">""" deploy operation """</span>
    <span class="n">service</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">"Rebuilding and deploying: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">api</span><span class="o">.</span><span class="n">lcd</span><span class="p">(</span><span class="n">SRC_ROOT</span><span class="p">):</span>
        <span class="n">api</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="s2">"make build"</span><span class="p">)</span>
        <span class="n">service</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"build_result"</span><span class="p">,</span> <span class="n">DEPLOY_PATH</span><span class="p">)</span>
    <span class="n">service</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="s2">"service daemon restart"</span><span class="p">)</span>
</pre></div>
<p><strong>Service context managers</strong>:</p>
<p>Here's another example operation which verifies the default system user and <code>sudo</code> capabilities on the remote side and introduces</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">api</span>

<span class="c1">## .. standard ymir preamble here, see previous examples ..</span>

<span class="k">def</span> <span class="nf">user_info</span><span class="p">():</span>
  <span class="sd">""" show remote user information """</span>
  <span class="c1"># to use normal fabric functions, use the service.ssh_ctx context manager</span>
  <span class="k">with</span> <span class="n">service</span><span class="o">.</span><span class="n">ssh_ctx</span><span class="p">():</span>
    <span class="n">api</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"whoami"</span><span class="p">)</span>
    <span class="n">api</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="s2">"whoami"</span><span class="p">)</span>

  <span class="c1"># if you use service helpers instead of vanilla fabric, you don't need a context manager</span>
  <span class="n">service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"whoami"</span><span class="p">)</span>
  <span class="n">service</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="s2">"whoami"</span><span class="p">)</span>
</pre></div>
<h4 id="footnotes">Footnotes</h4></div>
        </div>
        <footer>
          <p>&copy; mvr</p>
        </footer>
      </div>

    </div>
  </body>
</html>